#!/usr/bin/env bash
# commit-msg: block AI agent attribution in commit messages
set -euo pipefail

COMMIT_MSG_FILE="$1"
MSG="$(cat "$COMMIT_MSG_FILE")"

ERRORS=()

# ── 1. Block explicit co-author trailers ──────────────────────────────────────
if echo "$MSG" | grep -qiE '^(Co-Authored-By|Co-Author):'; then
  ERRORS+=("Co-author trailers are not allowed in commit messages.")
fi

# ── 2. Block AI agent attribution phrases ─────────────────────────────────────
# Matches "generated by/with/using <agent>", "assisted by <agent>", etc.
AI_ATTRIBUTION_PATTERN='(generated|created|written|authored|assisted|built|produced)[[:space:]]+(by|with|using)[[:space:]]+(claude|codex|gemini|copilot|gpt|chatgpt|openai|anthropic|cursor|llm|ai)'
if echo "$MSG" | grep -qiE "$AI_ATTRIBUTION_PATTERN"; then
  ERRORS+=("AI generation/attribution phrases are not allowed in commit messages.")
fi

# ── 3. Block standalone AI agent name references ─────────────────────────────
# Exempt lines that are clearly URLs (contain ://)
NON_URL_LINES=$(echo "$MSG" | grep -viE '://') || NON_URL_LINES=""
if [ -n "$NON_URL_LINES" ]; then
  AI_NAME_PATTERN='\b(claude|codex|copilot|chatgpt|openai|anthropic|cursor)\b'
  if echo "$NON_URL_LINES" | grep -qiE "$AI_NAME_PATTERN"; then
    ERRORS+=("References to AI agents (claude, codex, copilot, chatgpt, openai, anthropic, cursor) are not allowed.")
  fi
fi

# ── Report ────────────────────────────────────────────────────────────────────
if [ ${#ERRORS[@]} -gt 0 ]; then
  echo "[commit-msg] Commit rejected:"
  for err in "${ERRORS[@]}"; do
    echo "  - $err"
  done
  echo ""
  echo "  Write commit messages that describe what changed and why."
  echo "  Do not attribute changes to AI tools."
  exit 1
fi

# ── Chain global Databricks commit-msg hook if present ───────────────────────
GLOBAL_HOOKS_DIR="$(git config --global core.hooksPath 2>/dev/null || true)"
if [ -n "$GLOBAL_HOOKS_DIR" ] && [ -x "$GLOBAL_HOOKS_DIR/commit-msg" ]; then
  "$GLOBAL_HOOKS_DIR/commit-msg" "$@"
fi
